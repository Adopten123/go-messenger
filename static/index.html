<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Go Messenger Client</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .hidden { display: none; }

        /* Chat Styles */
        #chat-window { height: 400px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background: #fff; }
        .message { margin: 5px 0; padding: 8px 12px; border-radius: 15px; max-width: 70%; clear: both; }
        .message.mine { background: #007bff; color: white; float: right; }
        .message.theirs { background: #e4e6eb; color: black; float: left; }
        .typing { color: #888; font-style: italic; font-size: 0.9em; height: 20px; }

        .flex { display: flex; gap: 10px; }
    </style>
</head>
<body>

<h1>Go Messenger üöÄ</h1>

<div id="auth-section" class="card">
    <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
    <input type="text" id="username" placeholder="Username (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <div class="flex">
        <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button onclick="login()">–õ–æ–≥–∏–Ω</button>
    </div>
    <p id="auth-error" style="color: red;"></p>
</div>

<div id="lobby-section" class="card hidden">
    <h3>–ü—Ä–∏–≤–µ—Ç, <span id="current-user"></span>!</h3>
    <p>Token: <span id="token-display" style="font-size: 10px; color: #888;"></span></p>

    <h4>–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</h4>
    <input type="email" id="partner-email" placeholder="Email —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
    <button onclick="createChat()">–ù–∞—á–∞—Ç—å —á–∞—Ç</button>

    <hr>
    <h4>–í–æ–π—Ç–∏ –≤ —á–∞—Ç –ø–æ ID</h4>
    <div class="flex">
        <input type="text" id="chat-id-input" placeholder="Chat UUID">
        <button onclick="joinChat()">–í–æ–π—Ç–∏</button>
    </div>
</div>

<div id="chat-section" class="card hidden">
    <h3 id="chat-title">–ß–∞—Ç</h3>
    <div id="chat-window"></div>
    <div id="typing-indicator" class="typing"></div>

    <div class="flex">
        <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." oninput="handleTyping()">
        <button onclick="sendMessage()" style="width: 100px;">Send</button>
    </div>
    <button onclick="leaveChat()" style="background: #6c757d; margin-top: 10px;">–ù–∞–∑–∞–¥</button>
</div>

<script>
    const API_URL = "http://localhost:8082/api";
    const WS_URL = "ws://localhost:8082/api/ws";

    let state = {
        token: null,
        userID: null,
        username: null,
        chatID: null,
        socket: null
    };

    // --- AUTH ---

    async function register() {
        const body = getAuthData();
        const res = await fetch(`${API_URL}/users/register`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if (res.ok) alert("Registered! Now log in.");
        else alert("Error: " + await res.text());
    }

    async function login() {
        const body = getAuthData();
        const res = await fetch(`${API_URL}/users/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: body.email, password: body.password })
        });

        if (res.ok) {
            const data = await res.json();
            state.token = data.token;

            // –ü–æ–ª—É—á–∞–µ–º ID —é–∑–µ—Ä–∞ —á–µ—Ä–µ–∑ GetMe
            const meRes = await fetch(`${API_URL}/users/me`, {
                headers: { 'Authorization': `Bearer ${state.token}` }
            });
            const meData = await meRes.json();
            state.userID = meData.id;
            state.username = meData.username;

            showLobby();
            connectWS(); // –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–µ–±—Å–æ–∫–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
        } else {
            document.getElementById('auth-error').innerText = await res.text();
        }
    }

    // --- WEBSOCKET ---

    function connectWS() {
        if (state.socket) return;

        // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ–∫–µ–Ω –≤ URL
        state.socket = new WebSocket(`${WS_URL}?token=${state.token}`);

        state.socket.onopen = () => console.log("WS Connected üü¢");

        state.socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            console.log("WS Received:", msg);
            handleWsMessage(msg);
        };

        state.socket.onclose = () => console.log("WS Disconnected üî¥");
        state.socket.onerror = (err) => console.error("WS Error:", err);
    }

    function handleWsMessage(msg) {
        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É –æ—Ç–∫—Ä—ã—Ç–æ–º—É —á–∞—Ç—É
        if (msg.chat_id === state.chatID) {
            if (msg.type === "new_message") {
                appendMessage(msg.content, msg.sender_id === state.userID);
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ—á—Ç–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                // sendMarkRead(msg.chat_id);
            } else if (msg.type === "typing" && msg.sender_id !== state.userID) {
                showTyping();
            }
        }
    }

    // --- CHAT LOGIC ---

    async function createChat() {
        const email = document.getElementById('partner-email').value;
        const res = await fetch(`${API_URL}/chats`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${state.token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username: "Partner", partner_email: email }) // –£–ø—Ä–æ—â–µ–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
            // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í —Ç–≤–æ–µ–º –∫–æ–¥–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å username –∏–ª–∏ email, –ø—Ä–æ–≤–µ—Ä—å handler
        });

        if (res.ok) {
            const data = await res.json();
            state.chatID = data.chat_id;
            enterChat();
        } else {
            alert("Error creating chat: " + await res.text());
        }
    }

    function joinChat() {
        state.chatID = document.getElementById('chat-id-input').value;
        if(state.chatID) enterChat();
    }

    async function enterChat() {
        document.getElementById('lobby-section').classList.add('hidden');
        document.getElementById('chat-section').classList.remove('hidden');
        document.getElementById('chat-title').innerText = `–ß–∞—Ç: ${state.chatID}`;
        document.getElementById('chat-window').innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä–æ–µ

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ (REST)
        const res = await fetch(`${API_URL}/chats/${state.chatID}/messages?limit=50`, {
            headers: { 'Authorization': `Bearer ${state.token}` }
        });
        if (res.ok) {
            const msgs = await res.json();
            // –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º (–æ–±—ã—á–Ω–æ), –ø–æ—ç—Ç–æ–º—É —Ä–µ–≤–µ—Ä—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            msgs.reverse().forEach(m => {
                appendMessage(m.content, m.sender_id === state.userID);
            });
            scrollToBottom();
        }
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const content = input.value;
        if (!content) return;

        const msg = {
            type: "new_message",
            chat_id: state.chatID,
            content: content
        };

        state.socket.send(JSON.stringify(msg));
        // –ú—ã –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–∏, –∂–¥–µ–º –ø–æ–∫–∞ –æ–Ω–æ –≤–µ—Ä–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑ WS (echo)
        // –õ–∏–±–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ:
        // appendMessage(content, true);

        input.value = '';
    }

    // –¢–∞–π–ø–∏–Ω–≥
    let typingTimeout;
    function handleTyping() {
        state.socket.send(JSON.stringify({
            type: "typing",
            chat_id: state.chatID
        }));
    }

    function showTyping() {
        const el = document.getElementById('typing-indicator');
        el.innerText = "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–µ—á–∞—Ç–∞–µ—Ç...";
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            el.innerText = "";
        }, 3000);
    }

    // --- UI HELPERS ---

    function getAuthData() {
        return {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        };
    }

    function showLobby() {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('lobby-section').classList.remove('hidden');
        document.getElementById('current-user').innerText = state.username;
        document.getElementById('token-display').innerText = state.token.substring(0, 20) + "...";
    }

    function leaveChat() {
        document.getElementById('chat-section').classList.add('hidden');
        document.getElementById('lobby-section').classList.remove('hidden');
        state.chatID = null;
    }

    function appendMessage(text, isMine) {
        const div = document.createElement('div');
        div.className = `message ${isMine ? 'mine' : 'theirs'}`;
        div.innerText = text;
        const win = document.getElementById('chat-window');
        win.appendChild(div);
        // –û—á–∏—Å—Ç–∫–∞ float
        const clear = document.createElement('div');
        clear.style.clear = 'both';
        win.appendChild(clear);
        scrollToBottom();
    }

    function scrollToBottom() {
        const win = document.getElementById('chat-window');
        win.scrollTop = win.scrollHeight;
    }
</script>
</body>
</html>